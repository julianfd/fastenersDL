package standards.raisedcountersunkheadscrew

import standards.thread.ThreadSize
import standards.thread.Length
import topology.Bolt
import topology.RecessType
import topology.Standard

interface RaisedCountersunkStandard extends Standard {

	op getRecessType() : RecessType

	op getCountersinkAngle() : Unit[deg]

}

class RaisedCountersunkHeadScrew extends Bolt {
	RaisedCountersunkStandard standard
	thread           : ThreadSize
	length           : Unit[mm]
	Dia              : Unit[mm]
	countersinkAngle : Unit[deg]
	recessType       : RecessType

	P                : Unit[mm]
	a                : Unit[mm]
	b                : Unit[mm]
	dkTheo           : Unit[mm]
	dkMean           : Unit[mm]
	seatHeight       : Unit[mm]
	nMin             : Unit[mm]
	r                : Unit[mm]
	recessDepth      : Unit[mm]
	rf               : Unit[mm]
	cT               : Integer
	mH               : Unit[mm]
	torxCode         : Integer
	Ac               : Unit[mm]
	f                : Unit[mm]

	op setParameters(d:ThreadSize, l:Length) {
		if (standard === null) {
			throw new IllegalStateException("standard not set")
		}

		if (!standard.checkAllowedRange(d, l))
			throw new IllegalArgumentException("Given length " + l + " is out of range for thread " + d)

		thread = d
		length = rule geometry.GeometryUtil.op.getLength(l)
		Dia = rule geometry.GeometryUtil.op.getDia(d)
		countersinkAngle = standard.countersinkAngle
		recessType = standard.recessType
		val parameters = standard.getParameters.get(thread)
		if (parameters === null) {
			throw new IllegalArgumentException("Thread size not supported for " + standard.class.simpleName)
		}
		P = parameters.get(0) * 1[mm]
		a = parameters.get(1) * 1[mm]
		b = parameters.get(2) * 1[mm]
		dkTheo = parameters.get(3) * 1[mm]
		dkMean = parameters.get(4) * 1[mm]
		seatHeight = parameters.get(5) * 1[mm]
		nMin = parameters.get(6) * 1[mm]
		r = parameters.get(7) * 1[mm]
		recessDepth = parameters.get(8) * 1[mm]
		rf = parameters.get(9) * 1[mm]
		cT = parameters.get(10).intValue
		mH = parameters.get(11) * 1[mm]
		torxCode = parameters.get(12).intValue
		A = parameters.get(13) * 1[mm]
		f = parameters.get(14) * 1[mm]
	}
}

enum RaisedCountersunkStandardType {
	ISO2010, ISO7047, ISO14584
}

class ISO2010 extends RaisedCountersunkStandard {

	op getRecessType() : RecessType {
		return RecessType.SLOT
	}

	op getCountersinkAngle() : Unit[deg] {
		return 90[deg]
	}

	op getParameters() : Map<ThreadSize, List<Double>> {
		val Map<ThreadSize, List<Double>> paramMap = map
		paramMap.put(ThreadSize.M1_6, #{0.35, 0.7, 25.0, 3.6, 2.8, 1.0, 0.46, 0.2, 0.7, 3.0, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M2, #{0.4, 0.8, 25.0, 4.4, 3.6, 1.2, 0.56, 0.3, 0.9, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M2_5, #{0.45, 0.9, 25.0, 5.5, 4.5, 1.5, 0.66, 0.3, 1.1, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M3, #{0.5, 1.0, 25.0, 6.3, 5.3, 1.65, 0.86, 0.4, 1.3, 6.0, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M3_5, #{0.6, 1.2, 38.0, 8.2, 7.1, 2.35, 1.06, 0.4, 1.5, 8.5, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M4, #{0.7, 1.4, 38.0, 9.4, 8.2, 2.7, 1.26, 0.5, 1.8, 9.5, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M5, #{0.8, 1.6, 38.0, 10.4, 9.2, 2.7, 1.26, 0.6, 2.2, 9.5, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M6, #{1.0, 2.0, 38.0, 12.6, 11.2, 3.3, 1.66, 0.7, 2.6, 12.0, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M8, #{1.25, 2.5, 38.0, 17.3, 15.6, 4.65, 2.06, 1.0, 3.5, 16.5, 0.0, 0.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M10, #{1.5, 3.0, 38.0, 20.0, 18.1, 5.0, 2.56, 1.2, 4.1, 19.5, 0.0, 0.0, 0.0, 0.0, 0.0})
		return paramMap
	}

	op getAllowedRange(thread:ThreadSize) : List<Length> {
		val rangeMap = map
		rangeMap.put(ThreadSize.M1_6, #{Length.L2_5, Length.L16})
		rangeMap.put(ThreadSize.M2, #{Length.L3, Length.L20})
		rangeMap.put(ThreadSize.M2_5, #{Length.L4, Length.L25})
		rangeMap.put(ThreadSize.M3, #{Length.L5, Length.L30})
		rangeMap.put(ThreadSize.M3_5, #{Length.L6, Length.L35})
		rangeMap.put(ThreadSize.M4, #{Length.L6, Length.L40})
		rangeMap.put(ThreadSize.M5, #{Length.L8, Length.L50})
		rangeMap.put(ThreadSize.M6, #{Length.L8, Length.L60})
		rangeMap.put(ThreadSize.M8, #{Length.L10, Length.L80})
		rangeMap.put(ThreadSize.M10, #{Length.L12, Length.L80})
		val r = rangeMap.get(thread)
		if (r === null)
			throw new IllegalArgumentException("Thread size +" + thread + " not covered by the standard " + this.class)
		return rangeMap.get(thread)
	}
	
}

class ISO7047 extends RaisedCountersunkStandard {

	op getRecessType() : RecessType {
		return RecessType.CROSS
	}

	op getCountersinkAngle() : Unit[deg] {
		return 90[deg]
	}
	
	@Override
	op getParameters() : Map<ThreadSize, List<Double>> {
		val Map<ThreadSize, List<Double>> paramMap = map
		paramMap.put(ThreadSize.M1_6, #{0.35, 0.7, 25.0, 3.6, 2.8, 1.0, 0.46, 0.2, 0.7, 3.0, 0.0, 1.9, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M2, #{0.4, 0.8, 25.0, 4.4, 3.6, 1.2, 0.56, 0.3, 0.9, 4.0, 0.0, 2.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M2_5, #{0.45, 0.9, 25.0, 5.5, 4.5, 1.5, 0.66, 0.3, 1.1, 5.0, 1.0, 3.0, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M3, #{0.5, 1.0, 25.0, 6.3, 5.3, 1.65, 0.86, 0.4, 1.3, 6.0, 1.0, 3.4, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M3_5, #{0.6, 1.2, 38.0, 8.2, 7.1, 2.35, 1.06, 0.4, 1.5, 8.5, 2.0, 4.8, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M4, #{0.7, 1.4, 38.0, 9.4, 8.2, 2.7, 1.26, 0.5, 1.8, 9.5, 2.0, 5.2, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M5, #{0.8, 1.6, 38.0, 10.4, 9.2, 2.7, 1.26, 0.6, 2.2, 9.5, 2.0, 5.4, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M6, #{1.0, 2.0, 38.0, 12.6, 11.2, 3.3, 1.66, 0.7, 2.6, 12.0, 3.0, 7.3, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M8, #{1.25, 2.5, 38.0, 17.3, 15.6, 4.65, 2.06, 1.0, 3.5, 16.5, 4.0, 9.6, 0.0, 0.0, 0.0})
		paramMap.put(ThreadSize.M10, #{1.5, 3.0, 38.0, 20.0, 18.1, 5.0, 2.56, 1.2, 4.1, 19.5, 4.0, 10.4, 0.0, 0.0, 0.0})
		return paramMap
	}

	op getAllowedRange(thread:ThreadSize) : List<Length> {
		val rangeMap = map
		rangeMap.put(ThreadSize.M1_6, #{Length.L3, Length.L16})
		rangeMap.put(ThreadSize.M2, #{Length.L3, Length.L20})
		rangeMap.put(ThreadSize.M2_5, #{Length.L3, Length.L25})
		rangeMap.put(ThreadSize.M3, #{Length.L4, Length.L30})
		rangeMap.put(ThreadSize.M3_5, #{Length.L5, Length.L35})
		rangeMap.put(ThreadSize.M4, #{Length.L5, Length.L40})
		rangeMap.put(ThreadSize.M5, #{Length.L6, Length.L45})
		rangeMap.put(ThreadSize.M6, #{Length.L8, Length.L60})
		rangeMap.put(ThreadSize.M8, #{Length.L10, Length.L60})
		rangeMap.put(ThreadSize.M10, #{Length.L12, Length.L60})
		val r = rangeMap.get(thread)
		if (r === null)
			throw new IllegalArgumentException("Thread size +" + thread + " not covered by the standard " + this.class)
		return rangeMap.get(thread)
	}
	
}

class ISO14584 extends RaisedCountersunkStandard {

	op getRecessType() : RecessType {
		return RecessType.HEXALOBULAR
	}

	op getCountersinkAngle() : Unit[deg] {
		return 90[deg]
	}

	@Override
	op getParameters() : Map<ThreadSize, List<Double>> {
		val Map<ThreadSize, List<Double>> paramMap = map
		paramMap.put(ThreadSize.M2, #{0.4, 0.0, 25.0, 4.4, 3.8, 1.2, 0.0, 0.2, 0.7, 4.0, 0.0, 0.0, 6.0, 1.75, 0.5})
		paramMap.put(ThreadSize.M2_5, #{0.45, 0.0, 25.0, 5.5, 4.7, 1.5, 0.0, 0.3, 1.0, 5.0, 0.0, 0.0, 8.0, 2.4, 0.6})
		paramMap.put(ThreadSize.M3, #{0.5, 0.0, 25.0, 6.3, 5.5, 1.65, 0.0, 0.4, 1.2, 6.0, 0.0, 0.0, 10.0, 2.8, 0.7})
		paramMap.put(ThreadSize.M3_5, #{0.6, 0.0, 38.0, 8.2, 7.3, 2.35, 0.0, 0.4, 1.3, 8.5, 0.0, 0.0, 15.0, 3.35, 0.8})
		paramMap.put(ThreadSize.M4, #{0.7, 0.0, 38.0, 9.4, 8.4, 2.7, 0.0, 0.5, 1.5, 9.5, 0.0, 0.0, 20.0, 3.95, 1.0})
		paramMap.put(ThreadSize.M5, #{0.8, 0.0, 38.0, 10.4, 9.3, 2.7, 0.0, 0.6, 1.7, 9.5, 0.0, 0.0, 25.0, 4.5, 1.2})
		paramMap.put(ThreadSize.M6, #{1.0, 0.0, 38.0, 12.6, 11.3, 3.3, 0.0, 0.7, 2.2, 12.0, 0.0, 0.0, 30.0, 5.6, 1.4})
		paramMap.put(ThreadSize.M8, #{
			1.25, 0.0, 38.0, 17.3, 15.8, 4.65, 0.0, 1.0, 3.0, 16.5, 0.0, 0.0, 45.0, 7.95, 2.0})
		paramMap.put(ThreadSize.M10, #{1.5, 0.0, 38.0, 20.0, 18.3, 5.0, 0.0, 1.2, 3.8, 19.5, 0.0, 0.0, 50.0, 8.95, 2.3})
		return paramMap
	}

	op getAllowedRange(thread:ThreadSize) : List<Length> {
		val rangeMap = map
		rangeMap.put(ThreadSize.M2, #{Length.L3, Length.L20})
		rangeMap.put(ThreadSize.M2_5, #{Length.L3, Length.L25})
		rangeMap.put(ThreadSize.M3, #{Length.L4, Length.L30})
		rangeMap.put(ThreadSize.M3_5, #{Length.L5, Length.L35})
		rangeMap.put(ThreadSize.M4, #{Length.L5, Length.L40})
		rangeMap.put(ThreadSize.M5, #{Length.L6, Length.L50})
		rangeMap.put(ThreadSize.M6, #{Length.L8, Length.L60})
		rangeMap.put(ThreadSize.M8, #{Length.L10, Length.L60})
		rangeMap.put(ThreadSize.M10, #{Length.L12, Length.L60})
		val r = rangeMap.get(thread)
		if (r === null)
			throw new IllegalArgumentException("Thread size +" + thread + " not covered by the standard " + this.class)
		return rangeMap.get(thread)
	}
}
